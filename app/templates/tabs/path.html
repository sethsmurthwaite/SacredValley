<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sacred Valley • Your Path</title>

  <!-- Chart.js FIRST — critical -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #0f0f1b;
      --card: #1a1a2e;
      --text: #e0e0e0;
      --accent: #4169e1;
      --success: #50fa7b;
    }
    body { margin: 0; padding: 2rem; background: var(--bg); color: var(--text); font-family: system-ui, sans-serif; }
    .container { max-width: 1200px; margin: 0 auto; }

    .user-card, .analytics-card {
      background: var(--card);
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.6);
      margin-bottom: 2rem;
    }

    .paths-header {
      display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin: 2rem 0;
    }
    .time-range-selector {
      display: flex; gap: 0.5rem; background: #16213e; padding: 0.5rem; border-radius: 12px;
    }
    .range-btn {
      padding: 0.7rem 1.2rem; border: none; background: none; color: var(--text); border-radius: 8px; cursor: pointer; font-weight: 600;
    }
    .range-btn:hover { background: rgba(65,105,225,0.3); }
    .range-btn.active { background: var(--accent); color: white; }

    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
      gap: 1.5rem;
    }

    canvas { width: 100% !important; height: 300px !important; }

    /* Heatmap */
    .heatmap-header {
      display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;
    }
    .heatmap-legend {
      display: flex; align-items: center; gap: 1rem; font-size: 0.9rem; opacity: 0.8;
    }
    .color-scale { display: flex; gap: 4px; }
    .color-scale > div { width: 16px; height: 16px; border-radius: 4px; }
    .color-scale [data-level="0"] { background: #333; }
    .color-scale [data-level="1"] { background: #4169e1; }
    .color-scale [data-level="2"] { background: #6495ed; }
    .color-scale [data-level="3"] { background: #87cefa; }
    .color-scale [data-level="4"] { background: #50fa7b; }

    #contribution-grid {
      display: grid;
      gap: 3px;
      padding: 12px;
      background: rgba(0,0,0,0.3);
      border-radius: 12px;
      margin-top: 1rem;
    }
    .contribution-day {
      width: 11px; height: 11px;
      background: #333;
      border-radius: 3px;
      transition: all 0.2s;
      cursor: pointer;
    }
    .contribution-day:hover {
      transform: scale(1.6);
      box-shadow: 0 0 12px var(--accent);
      z-index: 10;
    }
    .contribution-day[data-level="1"] { background: #4169e1; }
    .contribution-day[data-level="2"] { background: #6495ed; }
    .contribution-day[data-level="3"] { background: #87cefa; }
    .contribution-day[data-level="4"] { background: #50fa7b; box-shadow: 0 0 10px #50fa7b; }

    .tooltip {
      position: absolute;
      background: rgba(0,0,0,0.95);
      color: white;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 0.9rem;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 10000;
      border: 1px solid var(--accent);
      white-space: nowrap;
    }
    .tooltip.visible { opacity: 1; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1.5rem;
    }
    .stat-item {
      text-align: center;
      padding: 1.5rem;
      background: rgba(65,105,225,0.1);
      border-radius: 12px;
      border: 1px solid rgba(65,105,225,0.3);
    }
    .stat-item p {
      font-size: 2.2rem;
      font-weight: bold;
      color: var(--success);
      margin: 0.5rem 0 0;
    }

    @media (max-width: 768px) {
      .stats-grid { grid-template-columns: 1fr; }
      .paths-header { flex-direction: column; align-items: stretch; }
    }
  </style>
</head>
<body>
  <div class="container">

    <div class="user-card">
      <h2>Your Sacred Path</h2>
      <p>Every completion forges your soul. Ascend through consistent cultivation.</p>
    </div>

    <div class="analytics-card">
      <div class="heatmap-header">
        <h3>Daily Cultivation Heatmap</h3>
        <div class="heatmap-legend">
          <span>Less</span>
          <div class="color-scale">
            <div data-level="0"></div>
            <div data-level="1"></div>
            <div data-level="2"></div>
            <div data-level="3"></div>
            <div data-level="4"></div>
          </div>
          <span>More</span>
        </div>
      </div>
      <div id="contribution-grid"></div>
      <div style="text-align:center; margin-top:1rem; opacity:0.7; font-size:0.9rem;">
        <small id="last-contribution">Loading...</small>
      </div>
    </div>

    <div class="paths-header">
      <h2>Analytics</h2>
      <div class="time-range-selector">
        <button class="range-btn active" data-range="week">Last 7 Days</button>
        <button class="range-btn" data-range="month">Last 30 Days</button>
        <button class="range-btn" data-range="year">This Year</button>
      </div>
    </div>

    <div class="analytics-grid">
      <div class="analytics-card">
        <h3>Madra Earned Over Time</h3>
        <canvas id="line-chart"></canvas>
      </div>
      <div class="analytics-card">
        <h3>Completions by Day</h3>
        <canvas id="bar-chart"></canvas>
      </div>
      <div class="analytics-card stats-grid">
        <div class="stat-item">
          <strong>Total Madra</strong>
          <p id="total-madra">0</p>
        </div>
        <div class="stat-item">
          <strong>Longest Streak</strong>
          <p id="longest-streak">0 days</p>
        </div>
        <div class="stat-item">
          <strong>Current Streak</strong>
          <p id="current-streak">0 days</p>
        </div>
        <div class="stat-item">
          <strong>Total Completions</strong>
          <p id="total-completions">0</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Your script — loads last -->
  <script>
    // === FULLY WORKING PATH.JS INLINE (no external file needed for now) ===
    document.addEventListener("DOMContentLoaded", () => {
      if (typeof Chart === "undefined") {
        alert("Chart.js failed to load!");
        return;
      }

      const grid = document.getElementById("contribution-grid");
      const lineCtx = document.getElementById("line-chart");
      const barCtx = document.getElementById("bar-chart");
      const buttons = document.querySelectorAll(".range-btn");
      let lineChart = null, barChart = null;
      let currentRange = "week";

      const generateData = () => {
        const days = currentRange === "year" ? 365 : currentRange === "month" ? 30 : 7;
        const contributions = {};
        const madraHistory = [];
        const dayCount = { Sun:0, Mon:0, Tue:0, Wed:0, Thu:0, Fri:0, Sat:0 };
        let totalMadra = 0, totalCompletions = 0, currentStreak = 0, longestStreak = 0, streak = 0;

        for (let i = days - 1; i >= 0; i--) {
          const date = new Date();
          date.setDate(date.getDate() - i);
          const key = date.toISOString().split('T')[0];
          const dayName = date.toLocaleDateString('en-US', {weekday: 'short'});
          const completions = i === 0 ? 0 : Math.floor(Math.random() * 5) || (Math.random() > 0.7 ? 4 : 0);
          const madra = completions * (15 + Math.random() * 10);

          contributions[key] = completions;
          madraHistory.push({date: key, madra: Math.round(madra)});
          dayCount[dayName] += completions;
          totalMadra += madra;
          totalCompletions += completions;

          if (completions > 0) {
            streak++;
            longestStreak = Math.max(longestStreak, streak);
          } else if (i > 0) {
            streak = 0;
          }
        }
        currentStreak = streak;

        return { contributions, madraHistory, dayCount, stats: {totalMadra, totalCompletions, currentStreak, longestStreak} };
      };

      const renderHeatmap = (data) => {
        grid.innerHTML = "";
        grid.style.gridTemplateColumns = currentRange === "year" ? "repeat(52, 11px)" : "repeat(7, 11px)";

        const today = new Date();
        const totalDays = currentRange === "year" ? 365 : currentRange === "month" ? 30 : 7;

        for (let i = totalDays - 1; i >= 0; i--) {
          const date = new Date(today);
          date.setDate(date.getDate() - i);
          const key = date.toISOString().split('T')[0];
          const level = data.contributions[key] || 0;

          const day = document.createElement("div");
          day.className = "contribution-day";
          day.dataset.level = level > 4 ? 4 : level;
          day.title = `${level} completions on ${date.toLocaleDateString()}`;

          day.onmouseenter = () => {
            let tooltip = document.querySelector(".tooltip");
            if (!tooltip) {
              tooltip = document.createElement("div");
              tooltip.className = "tooltip";
              document.body.appendChild(tooltip);
            }
            tooltip.textContent = `${level} completion${level !== 1 ? 's' : ''} • ${date.toLocaleDateString('en-US', {weekday: 'long', month: 'long', day: 'numeric'})}`;
            tooltip.classList.add("visible");
            const rect = day.getBoundingClientRect();
            tooltip.style.top = (rect.top + window.scrollY - 40) + "px";
            tooltip.style.left = (rect.left + window.scrollX + rect.width/2 - tooltip.offsetWidth/2) + "px";
          };
          day.onmouseleave = () => document.querySelector(".tooltip")?.classList.remove("visible");

          grid.appendChild(day);
        }
      };

      const renderCharts = (data) => {
        if (lineChart) lineChart.destroy();
        if (barChart) barChart.destroy();

        lineChart = new Chart(lineCtx, {
          type: "line",
          data: {
            labels: data.madraHistory.map(d => new Date(d.date).toLocaleDateString('en-US', {month:'short', day:'numeric'})),
            datasets: [{
              data: data.madraHistory.map(d => d.madra),
              borderColor: "#50fa7b",
              backgroundColor: "rgba(80,250,123,0.2)",
              tension: 0.4,
              fill: true,
              pointRadius: 4,
              pointHoverRadius: 8
            }]
          },
          options: { responsive: true, plugins: { legend: { display: false } } }
        });

        barChart = new Chart(barCtx, {
          type: "bar",
          data: {
            labels: Object.keys(data.dayCount),
            datasets: [{ data: Object.values(data.dayCount), backgroundColor: "#4169e1", borderRadius: 6 }]
          },
          options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });

        document.getElementById("total-madra").textContent = Math.round(data.stats.totalMadra).toLocaleString();
        document.getElementById("longest-streak").textContent = data.stats.longestStreak + " days";
        document.getElementById("current-streak").textContent = data.stats.currentStreak + " days";
        document.getElementById("total-completions").textContent = data.stats.totalCompletions;
      };

      const update = () => {
        const data = generateData();
        renderHeatmap(data);
        renderCharts(data);
        document.getElementById("last-contribution").textContent = data.stats.currentStreak > 0 ? "Active today" : "Keep cultivating!";
      };

      buttons.forEach(btn => btn.addEventListener("click", () => {
        buttons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentRange = btn.dataset.range;
        update();
      }));

      update();
    });
  </script>
</body>
</html>